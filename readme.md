# 联邦学习项目结构与安全机制说明

本项目基于 Flower、PyTorch、Opacus（差分隐私）和 Paillier 同态加密，实现了一个安全的联邦学习系统，适用于KDD数据集的二分类任务。**本说明重点突出模型结构与安全机制设计。**

---

## 1. 主要组成

- **pt_server.py**：联邦学习服务器端，负责聚合客户端模型参数（含同态加密聚合）、日志记录、启动与管理联邦学习流程。
- **pt_client.py**：联邦学习客户端，负责本地数据处理、模型训练（含差分隐私）、参数加密与上传、接收全局模型参数并更新本地模型。
- **eval_on_kddtest.py**：用于加载训练好的模型权重，在验证集或测试集上评估模型性能。

---

## 2. 数据处理流程

- **数据准备**（在客户端执行）：
  - 读取原始KDDTrain+数据集。
  - 标签二分类处理（normal为0，其余为1）。
  - 数值特征归一化（RobustScaler）。
  - 类别特征One-hot编码。
  - PCA降维到20维。
  - 划分为验证集、alice和bob两个客户端的数据集，分别保存为`.npz`文件。
  - 保存归一化和PCA模型、特征列顺序。

---

## 3. 模型结构

### PTModel

本项目采用的模型为**深度前馈神经网络（DNN）+自注意力机制**，结构如下：

- **输入层**：输入维度为20（PCA降维后特征）。
- **多层全连接层**：依次为64、128、512、128维，每层后接ReLU激活和Dropout，增强模型表达能力并防止过拟合。
- **自定义自注意力层（SelfAttention）**：在第二层全连接后插入，能够捕捉特征间的全局依赖关系，提升模型对复杂数据的建模能力。
- **输出层**：Sigmoid激活，输出1维，适合二分类任务。

**模型特点：**
- 不是CNN，也不是标准Transformer，而是DNN+单头自注意力模块。
- 结构紧凑，适合联邦学习场景下的高效训练与加密传输。
- 自注意力机制提升了模型对特征交互的捕捉能力。

---

## 4. 安全与隐私机制

本项目在安全与隐私保护方面采用了**Paillier同态加密**与**差分隐私**的协同机制，极大提升了联邦学习过程中的数据安全性和隐私保护能力。

### 4.1 Paillier同态加密

- **加密流程**：
  - 仅第一个客户端（如alice）生成Paillier公私钥对，公钥通过本地文件分发给所有客户端和服务器，私钥仅alice持有，绝不通过网络传递。
  - 所有客户端用同一个公钥对本地模型参数（仅最后一层，且仅非零参数）加密，上传密文到服务器。
  - 服务器在密文域内直接聚合（同态加法），聚合结果依然是密文，服务器无法解密。
  - 聚合后的密文参数下发所有客户端，只有持有私钥的客户端（alice）能解密获得明文聚合参数，其它客户端无法解密密文参数，保持为零或默认值，仅用于本地训练和聚合。

- **安全性说明**：
  - 公钥可公开，私钥绝不外泄，保证密文安全。
  - 服务器和其它客户端无法解密密文参数，防止模型参数泄露。
  - 若需多方共同解密，可扩展为门限加密或安全多方计算（SMPC）方案。

### 4.2 差分隐私

- **本地训练阶段**，采用Opacus库对模型参数更新过程进行差分隐私保护，严格控制隐私预算（ε、δ）。
- 即使攻击者获得了客户端上传的参数或统计量，也难以还原出原始训练数据。

### 4.3 协同增强安全性

- **同态加密**保护了参数传输和聚合过程中的数据安全，防止服务器或中间人窃取敏感统计量。
- **差分隐私**则从源头上限制了单个客户端上传信息的可逆性，即使加密被破解，统计量本身也已被扰动，难以还原原始数据。
- 两者结合，形成了“端到端加密+本地扰动”的双重防护体系。

---

## 5. 联邦学习流程

### 客户端（pt_client.py）

1. **加载本地数据**（alice或bob）。
2. **初始化模型**，应用差分隐私（Opacus）。
3. **密钥管理**：alice生成密钥对，其它客户端等待并加载公钥。
4. **与服务器通信**（Flower框架）：
   - **get_parameters**：上传本地模型参数（最后一层密文，其它层明文）。
   - **set_parameters**：接收并加载服务器聚合后的全局模型参数（只有alice能解密密文参数）。
   - **fit**：本地训练一轮，应用差分隐私，上传新参数。
   - **evaluate**：在本地验证集评估模型，返回准确率等指标。
5. **保存本地和全局模型权重**。

### 服务器端（pt_server.py）

1. **启动日志系统**。
2. **定义加密聚合策略**（EncryptedFedAvg）：
   - **aggregate_fit**：同态加密下聚合各客户端上传的参数，聚合后再编码上传。
   - **aggregate_evaluate**：聚合客户端评估指标（如准确率、损失）。
3. **启动Flower服务器**，指定聚合策略、训练轮数等参数。

---

## 6. 测试与评估（eval_on_kddtest.py）

- 加载训练好的模型权重。
- 对验证集或KDDTest+测试集进行预处理（与训练一致）。
- 评估模型准确率。

---

## 7. 总结

- **模型结构**：深度前馈神经网络+DNN+自注意力，结构紧凑，表达能力强。
- **安全机制**：Paillier同态加密+差分隐私，保证参数传输与聚合过程的安全与隐私。
- **密钥管理**：私钥仅由一个可信客户端持有，公钥分发所有参与方，杜绝私钥泄露风险。
- **适用场景**：适合对数据安全和隐私有高要求的联邦学习应用。
