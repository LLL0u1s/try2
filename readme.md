# 联邦学习项目结构与流程说明

本项目基于 Flower、PyTorch、Opacus（差分隐私）和 TenSEAL（同态加密）实现了一个安全的联邦学习系统，适用于KDD数据集的二分类任务。以下为整体结构与流程梳理：

---

## 1. 主要组成

- **pt_server.py**：联邦学习服务器端，负责聚合客户端模型参数（含同态加密聚合）、日志记录、启动与管理联邦学习流程。
- **pt_client.py**：联邦学习客户端，负责本地数据处理、模型训练（含差分隐私）、参数加密与上传、接收全局模型参数并更新本地模型。
- **eval_on_kddtest.py**：用于加载训练好的模型权重，在验证集或测试集上评估模型性能。

---

## 2. 数据处理流程

- **数据准备**（在客户端执行）：
  - 读取原始KDDTrain+数据集。
  - 标签二分类处理（normal为0，其余为1）。
  - 数值特征归一化（RobustScaler）。
  - 类别特征One-hot编码。
  - PCA降维到20维。
  - 划分为验证集、alice和bob两个客户端的数据集，分别保存为`.npz`文件。
  - 保存归一化和PCA模型、特征列顺序。

---

## 3. 模型结构

- **PTModel**：
  - 多层全连接网络，含Dropout。
  - 中间包含自定义的自注意力层（SelfAttention）。
  - 输出层为sigmoid激活，适用于二分类。

---

## 4. 客户端训练流程（pt_client.py）

1. **加载本地数据**（alice或bob）。
2. **初始化模型**，应用差分隐私（Opacus）。
3. **初始化同态加密上下文**（TenSEAL CKKS）。
4. **与服务器通信**（Flower框架）：
   - **get_parameters**：上传本地模型参数、均值、方差、梯度（均加密），以及加密上下文。
   - **set_parameters**：接收并加载服务器聚合后的全局模型参数（可解密聚合统计量）。
   - **fit**：本地训练一轮，应用差分隐私，上传新参数。
   - **evaluate**：在本地验证集评估模型，返回准确率等指标。
5. **保存本地和全局模型权重**。

---

## 5. 服务器端聚合流程（pt_server.py）

1. **启动日志系统**。
2. **定义加密聚合策略**（EncryptedFedAvg）：
   - **aggregate_fit**：同态加密下聚合各客户端上传的参数均值、方差、梯度等统计量，聚合后再编码上传。
   - **aggregate_evaluate**：聚合客户端评估指标（如准确率、损失）。
3. **启动Flower服务器**，指定聚合策略、训练轮数等参数。

---

## 6. 测试与评估（eval_on_kddtest.py）

- 加载训练好的模型权重。
- 对验证集或KDDTest+测试集进行预处理（与训练一致）。
- 评估模型准确率。

---

## 7. 安全与隐私

本项目在安全与隐私保护方面采用了**同态加密**与**差分隐私**的协同机制，极大提升了联邦学习过程中的数据安全性和隐私保护能力。

### 7.1 同态加密统计量

- **同态加密（Homomorphic Encryption, HE）**允许在密文上直接进行加法、乘法等运算，聚合后无需解密即可得到正确结果。
- 在本项目中，客户端会对本地模型参数的**均值、方差、梯度**等统计量进行同态加密（使用TenSEAL CKKS方案），再上传到服务器。
- 服务器端在收到多个客户端的加密统计量后，直接在密文域内进行聚合（如加权平均），聚合结果依然是密文，服务器无法解密。
- 只有客户端持有私钥，聚合后的统计量回传客户端后，客户端可解密获得全局统计信息。
- 这种方式确保了即使服务器被攻击或泄露，也无法直接获取到任何单个客户端的明文参数或统计量。

### 7.2 差分隐私

- **差分隐私（Differential Privacy, DP）**通过在本地训练过程中对梯度进行裁剪和噪声注入，防止通过模型参数反推出原始数据。
- 本项目采用Opacus库，在每轮本地训练时对模型参数更新过程进行差分隐私保护，严格控制隐私预算（ε、δ）。
- 即使攻击者获得了客户端上传的参数或统计量，也难以还原出原始训练数据。

### 7.3 协同增强安全性

- **同态加密**保护了参数传输和聚合过程中的数据安全，防止服务器或中间人窃取敏感统计量。
- **差分隐私**则从源头上限制了单个客户端上传信息的可逆性，即使加密被破解，统计量本身也已被扰动，难以还原原始数据。
- 两者结合，形成了“端到端加密+本地扰动”的双重防护体系：
  - 客户端本地训练时已做差分隐私保护，上传前再加密统计量。
  - 服务器端只处理密文，无法获取明文信息。
  - 聚合结果回传客户端后，只有持有私钥的客户端可解密，且解密后数据已具备差分隐私保护。
- 这种设计极大提升了联邦学习系统的抗攻击能力和隐私保护强度，适用于对数据安全要求极高的场景。

---

## 8. 运行流程总结

1. 客户端准备并预处理数据，初始化模型和加密环境。
2. 客户端与服务器协同训练，每轮本地训练后上传加密参数。
3. 服务器端聚合加密参数，生成全局模型，再下发给各客户端。
4. 训练完成后，可用eval脚本对模型效果进行评估。

---

如需更详细的某一部分流程说明，可查阅对应的源代码或继续提问